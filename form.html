<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="box" contenteditable="true"></div>
        <div class="box" contenteditable="true"></div>
        <div class="box" contenteditable="true"></div>
    </div>
    <div class="change-color"></div>
    

    <div class="popup">
        <form>
            <input type="number" name="width" placeholder="width">
            <input type="number" name="height" placeholder="height">
            <div>
                <input type="radio" name="type" value="1" checked="checked">
                <label for="1">iPhone X</label>
            </div>
            <div>
                <input type="radio" name="type" value="0">
                <label for="0">Other</label>
            </div>
            <input type="submit" value="Submit">
            <button class="cancel">Cancel</button>
        </form>
        <a href="" download>Download Image</a>
    </div>

    <script src="./node_modules/dom-to-image/dist/dom-to-image.min.js"></script>
    <script src="./node_modules/randomcolor/randomColor.js"></script>
    <script>
        var boxes = document.querySelectorAll('.box');
        var goals = JSON.parse(window.localStorage.getItem('goals'));
        if( Array.isArray(goals) ) {
            boxes[0].innerText = goals[0];
            boxes[1].innerText = goals[1];
            boxes[2].innerText = goals[2];
        } else {
            goals = ['','',''];
        }

        for(let i = 0; i < boxes.length; i++) {
            boxes[i].addEventListener('paste', function(e){
                e.preventDefault()
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                try {
                    paste = paste.toString();
                } catch(e){}
                console.log(paste)
                e.target.innerHTML = paste;
            })
        }

        setInterval(() => {
            var isDifferent = false;
            for(let i = 0; i < boxes.length; i++) {
                if( goals[i] != boxes[i].innerText ) {
                   isDifferent = true; 
                }
                goals[i] = boxes[i].innerText;
            }
            if( isDifferent ) {
                window.localStorage.setItem('goals', JSON.stringify(goals));
            }
        }, 100);

        var container = document.querySelector('.container');
        var popup = document.querySelector('.popup');
        var form = document.querySelector('form');
        var downloadLink = popup.querySelector('[download]');
        var cancelButton = document.querySelector('.cancel');
        document.querySelector('.change-color').addEventListener('click', (e) => {  popup.classList.add('active');  });
        cancelButton.addEventListener('click', (e) => {  
            popup.classList.remove('active');  
            downloadLink.classList.remove('active');
        });
        
        var deviceTypes = {
            '1': [375,812], // iPhone X
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            var form = new FormData(e.target);
            var type = form.get('type');
            if( type == '1' ) {
                var [width,height] = deviceTypes[type];
            } else {
                var width = parseInt(form.get('width'));
                var height = parseInt(form.get('height'));
            }
            if( isNaN(width) || isNaN(height) ) {
                alert('Invalid form options.')
                return;
            }
            container.style.width = `${width}px`;
            container.style.height = `${height}px`;
            container.style.overflow = 'visible';

             domtoimage.toBlob(container).then(function (blob) {
                let url = window.URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.classList.add('active')
            });
        });

        // function hexToRgb(hex) {
        //     var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        //     return result ? {
        //         r: parseInt(result[1], 16),
        //         g: parseInt(result[2], 16),
        //         b: parseInt(result[3], 16)
        //     } : null;
        // }

        // var container = document.querySelector('.container');
        // document.querySelector('.change-color').addEventListener('click', (e) => {
        //     var color = '#' + Math.floor(Math.random()*16777215).toString(16);
        //     var otherColor = randomColor({ count: 1, hue: color });

        //     var rgb = hexToRgb(otherColor);
        //     var bwColor = (Math.max(rgb.r,rgb.g,rgb.b) + Math.min(rgb.r,rgb.g,rgb.b))/2;
        //     bwColor = bwColor < 128 ? 0 : 255;
        //     var textColor = `rgb(${bwColor},${bwColor},${bwColor})`;
        //     container.style.background = color;
        //     for(let i = 0; i < boxes.length; i++) {
        //         boxes[i].style.background = otherColor;
        //         boxes[i].style.color = textColor;
        //     }
        // });
    </script>
</body>
</html>